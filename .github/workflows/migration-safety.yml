name: Migration Safety Check

on:
  pull_request:
    paths:
      - 'packages/api/src/db/migrations/**'
      - 'packages/api/src/db/schema/**'
      - 'packages/api/drizzle/**'

jobs:
  analyze-migrations:
    name: Analyze Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get changed migration files
        id: changed
        run: |
          CHANGED=$(git diff --name-only origin/main...HEAD -- '*.sql' 2>/dev/null || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found changed files: $CHANGED"

      - name: Analyze migrations for destructive operations
        id: analyze
        run: |
          node scripts/analyze-migrations.mjs "${{ steps.changed.outputs.files }}"

      - name: Block destructive migrations
        if: steps.analyze.outputs.has_destructive == 'true'
        run: |
          echo "::error::Destructive migration detected! See details below."
          echo "${{ steps.analyze.outputs.details }}"
          echo ""
          echo "To proceed with a destructive migration, you must:"
          echo "1. Add the 'migration-destructive-approved' label to this PR"
          echo "2. Get approval from a DBA team member"
          echo "3. Follow the expand/contract pattern in a separate PR"
          exit 1

  # Require DBA approval for destructive migrations
  require-dba-approval:
    name: DBA Approval Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'migration-destructive-approved')
    steps:
      - name: Check for DBA approval
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            // Define DBA team members who can approve destructive migrations
            const dbaTeam = process.env.DBA_APPROVERS?.split(',') || [];

            const dbaApproval = reviews.find(review =>
              review.state === 'APPROVED' &&
              dbaTeam.includes(review.user.login)
            );

            if (!dbaApproval && dbaTeam.length > 0) {
              core.setFailed('Destructive migrations require DBA team approval');
            } else {
              console.log('DBA approval found or no DBA team configured');
            }
        env:
          DBA_APPROVERS: ${{ vars.DBA_APPROVERS }}
