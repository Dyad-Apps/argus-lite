# Architecture â†” Mock UI Alignment

## Executive Summary

This document maps the IoT Platform Architecture to the mock UI (`C:\source\paas`) to ensure alignment between backend design and frontend requirements. It identifies gaps, clarifies concepts, and recommends adjustments.

---

## Key Findings

### 1. Terminology Clarification

The mock UI and architecture documents use overlapping terms with different meanings:

| Term | Mock UI Meaning | Architecture Meaning | Resolution |
|------|----------------|---------------------|------------|
| **Asset Profile** | Platform configuration for asset-device-space relationships | âŒ Not used | Keep mock UI meaning |
| **Asset Type** | Hierarchical categorization (3 levels: Category â†’ Subcategory â†’ Specific) | Categorical classification | Same concept |
| **Asset Type Profile** | âŒ Not in mock | Telemetry processing rules per asset type | **NEW: Add to architecture** |

**Recommendation**:
- **Asset Profile** = Platform configuration (device binding, location, dashboards) - EXISTS in mock
- **Asset Type** = Hierarchical taxonomy - EXISTS in mock
- **Asset Type Telemetry Configuration** = NEW concept to add processing rules to Asset Types

---

## 2. Mock UI Structure

### Asset Hub Routes (from AssetHub.tsx)

```
/org/asset-hub
  â”œâ”€ /assets              â†’ List all assets
  â”œâ”€ /assets/:id          â†’ Asset detail page with tabs
  â”œâ”€ /types               â†’ Manage asset type hierarchy
  â”œâ”€ /profiles            â†’ Manage asset profiles (device binding configs)
  â”œâ”€ /groups              â†’ Asset groups
  â”œâ”€ /templates           â†’ Dashboard templates
  â”œâ”€ /triggers            â†’ Group triggers
  â””â”€ /alarms              â†’ Alarms & events
```

### Asset Detail Tabs (from mock)

```
Asset Details Page
  â”œâ”€ Overview             â†’ Basic info, status, location
  â”œâ”€ IoT                  â†’ Sub-tabs:
  â”‚   â”œâ”€ Dashboard        â†’ Real-time metrics visualization
  â”‚   â”œâ”€ Telemetry        â†’ Historical telemetry data table
  â”‚   â””â”€ Devices          â†’ Linked device management
  â”œâ”€ Location             â†’ Space placement, RTLS tracking
  â”œâ”€ Maintenance          â†’ Maintenance logs
  â”œâ”€ Documents            â†’ Attached files
  â”œâ”€ Alarms               â†’ Alarm history
  â”œâ”€ Telematics           â†’ Vehicle-specific (if applicable)
  â””â”€ Audit                â†’ Change history
```

---

## 3. Data Model Comparison

### Mock UI Asset Type (asset-type.ts)

```typescript
interface AssetTypeNode {
  id: string;
  name: string;
  description?: string;
  icon: string;
  color?: string;
  parent_id: string | null;
  level: 1 | 2 | 3;                      // Max 3 levels
  path: string;                          // "vehicles/trucks/delivery"
  defaultTelemetryKeys?: string[];       // Simple list of keys
  customFields?: AssetTypeCustomField[]; // Custom form fields
  assetCount: number;
  isSystem?: boolean;
}
```

**Gap**: No telemetry processing configuration!

### Architecture Asset Type (asset-types.ts - current)

```typescript
export const assetTypes = pgTable('asset_types', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  icon: text('icon'),
  category: text('category'),
  attributeSchema: jsonb('attribute_schema'),
  telemetrySchema: jsonb('telemetry_schema'),      // Poorly defined
  presentationConfig: jsonb('presentation_config'),
  parentTypeId: uuid('parent_type_id'),
});
```

**Gap**: `telemetrySchema` is vague and doesn't match architecture design!

### Architecture Enhancement (Asset_Type_Profile_Architecture.md)

```sql
ALTER TABLE asset_types
  ADD COLUMN metric_definitions JSONB,       -- What metrics this type tracks
  ADD COLUMN transformation_engine JSONB,     -- How to transform device â†’ asset metrics
  ADD COLUMN health_algorithm JSONB,          -- Health score computation rules
  ADD COLUMN threshold_rules JSONB,           -- Warning/critical thresholds
  ADD COLUMN event_rules JSONB,               -- Event generation conditions
  ADD COLUMN aggregation_rules JSONB,         -- Parent-child rollup rules
  ADD COLUMN validation_rules JSONB;          -- Data quality checks
```

**This is what's missing from the mock!**

---

## 4. Mock UI Asset Profile (Platform Config)

### From asset-type.ts

```typescript
interface AssetProfile {
  id: string;
  name: string;

  // Device Integration
  deviceMode: 'auto' | 'template' | 'manual';
  maxDevicesPerAsset: number;
  enforceOneToOne: boolean;
  dashboardTemplateId?: string;
  autoGenerateDashboard: boolean;

  // Location Settings
  locationMode: 'static' | 'tracked' | 'inherited';
  requireSpace: boolean;
  inheritSpaceFromDevice: boolean;
  enableRTLS: boolean;

  // Telemetry Settings
  defaultTelemetryKeys: string[];           // Just a list!
  aggregateTelemetry: boolean;
  telemetryRetentionDays: number;

  // Access Control
  restrictByAssetType: boolean;
  assetTypeIds?: string[];

  // Alarm Settings
  inheritAlarmsFromDevices: boolean;
}
```

**Purpose**: Controls HOW assets integrate with devices/spaces, not HOW telemetry is processed.

**Relationship to Architecture**:
- `deviceMode: 'auto'` â†’ Asset automatically linked to devices matching criteria
- `deviceMode: 'template'` â†’ Use device from dashboard template
- `deviceMode: 'manual'` â†’ User manually links devices
- `aggregateTelemetry: true` â†’ Combine telemetry from multiple devices (matches `aggregation_rules` concept)

---

## 5. What's Missing in Mock UI

### 5.1 Telemetry Processing Configuration UI

The mock UI has NO interface for configuring:
- How device metrics map to asset metrics
- Derived metric formulas
- Health score algorithms
- Threshold rules
- Event generation rules

**Current Mock Flow**:
```
Asset.telemetryKeys = ['temperature', 'humidity', 'power_consumption']
                      â†“
Telemetry Tab displays these keys from telemetry_history table
                      â†“
Dashboard Tab shows widgets for these keys
```

**Missing**:
- Where are `power_consumption` derived from `voltage * current`?
- How is health score computed?
- Who defines thresholds?

### 5.2 Asset Type Configuration Page

The mock has **Asset Types** page (AssetTypes.tsx) but it only manages:
- Hierarchical structure
- Icons and colors
- Custom fields

**Recommendation**: Add "Telemetry Configuration" tab to Asset Type details:

```
Asset Type Details Page
  â”œâ”€ General              â†’ Name, icon, hierarchy
  â”œâ”€ Custom Fields        â†’ Form field definitions
  â”œâ”€ Telemetry Config     â†’ â­ NEW
  â”‚   â”œâ”€ Metrics          â†’ Define available metrics
  â”‚   â”œâ”€ Transformations  â†’ Map device â†’ asset metrics
  â”‚   â”œâ”€ Health Algorithm â†’ Configure health scoring
  â”‚   â”œâ”€ Thresholds       â†’ Warning/critical levels
  â”‚   â””â”€ Events           â†’ Event generation rules
  â””â”€ Preview              â†’ Test with sample data
```

---

## 6. Integration Recommendations

### 6.1 Extend Mock Asset Type Interface

Add telemetry configuration to `AssetTypeNode`:

```typescript
interface AssetTypeNode {
  // ... existing fields ...
  defaultTelemetryKeys?: string[];
  customFields?: AssetTypeCustomField[];

  // â­ ADD THESE:
  telemetryConfig?: {
    metricDefinitions?: MetricDefinition[];      // From architecture
    transformationEngine?: TransformationEngine; // From architecture
    healthAlgorithm?: HealthAlgorithm;          // From architecture
    thresholdRules?: ThresholdRules;            // From architecture
    eventRules?: EventRules;                    // From architecture
    aggregationRules?: AggregationRules;        // From architecture
    validationRules?: ValidationRules;          // From architecture
  };
}
```

### 6.2 Asset Profile vs Asset Type Config

**Asset Profile** (platform config):
- **Purpose**: Controls asset-device-space RELATIONSHIPS
- **Scope**: Cross-type configuration (applies to multiple asset types)
- **Examples**:
  - "All vehicles use RTLS tracking"
  - "Equipment assets aggregate telemetry from multiple sensors"
  - "Critical assets auto-generate dashboards"

**Asset Type Telemetry Config** (processing rules):
- **Purpose**: Defines telemetry PROCESSING logic
- **Scope**: Per asset type (each type has unique metrics)
- **Examples**:
  - "Pumps compute efficiency from flow and power"
  - "HVAC units compute cooling capacity"
  - "Generators emit critical alarm when temperature > 85Â°C"

**Both are needed!**

---

## 7. UI Mockup Additions

### 7.1 Asset Type Telemetry Configuration Page

**Route**: `/org/asset-hub/types/:typeId/telemetry`

**Sections**:

#### A. Metric Definitions

```
â”Œâ”€ Metric Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  Define what metrics this asset type tracks              â”‚
â”‚                                                           â”‚
â”‚  [+ Add Metric]                                          â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€ motor_temperature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Display Name: Motor Temperature         â”‚             â”‚
â”‚  â”‚ Unit: celsius                            â”‚             â”‚
â”‚  â”‚ Type: numeric (precision: 1)            â”‚             â”‚
â”‚  â”‚ Range: -50 to 150                        â”‚             â”‚
â”‚  â”‚ [Edit] [Delete]                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€ power_consumption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ Display Name: Power Consumption          â”‚             â”‚
â”‚  â”‚ Unit: watts                              â”‚             â”‚
â”‚  â”‚ Type: numeric (derived)                  â”‚             â”‚
â”‚  â”‚ Formula: voltage * current * power_factorâ”‚             â”‚
â”‚  â”‚ [Edit] [Delete]                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### B. Transformation Engine

```
â”Œâ”€ Device â†’ Asset Metric Mapping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  Map device telemetry to asset metrics                   â”‚
â”‚                                                           â”‚
â”‚  Device Metric              Asset Metric                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â†’  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ device.temp     â”‚    â†’  â”‚ motor_temperature â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â†’  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ device.voltage  â”‚    â†’  â”‚ voltage           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â”‚  [+ Add Mapping]                                         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€ Derived Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ power_consumption = voltage * current * pf  â”‚        â”‚
â”‚  â”‚ efficiency = (output / input) * 100          â”‚        â”‚
â”‚  â”‚ [+ Add Formula]                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### C. Health Algorithm Designer

```
â”Œâ”€ Health Score Algorithm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  Base Score: [100] â–¼                                     â”‚
â”‚  Algorithm: [Weighted Deductions] â–¼                      â”‚
â”‚                                                           â”‚
â”‚  Rules:                                                   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€ Rule 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Metric: motor_temperature                  â”‚         â”‚
â”‚  â”‚ Condition: above 90Â°C â†’ Deduct 40 points   â”‚         â”‚
â”‚  â”‚           above 75Â°C â†’ Deduct 20 points   â”‚         â”‚
â”‚  â”‚           above 60Â°C â†’ Deduct 5 points    â”‚         â”‚
â”‚  â”‚ [Edit] [Delete]                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€ Rule 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Metric: vibration_level                    â”‚         â”‚
â”‚  â”‚ Condition: above 10.0 â†’ Deduct 50 points   â”‚         â”‚
â”‚  â”‚           above 7.0 â†’ Deduct 25 points    â”‚         â”‚
â”‚  â”‚ [Edit] [Delete]                            â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                           â”‚
â”‚  [+ Add Rule]                                            â”‚
â”‚                                                           â”‚
â”‚  Preview:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Test Inputs:                               â”‚         â”‚
â”‚  â”‚ motor_temperature: [85] Â°C                 â”‚         â”‚
â”‚  â”‚ vibration_level: [8.5] mm/s                â”‚         â”‚
â”‚  â”‚                                             â”‚         â”‚
â”‚  â”‚ Calculated Health Score: [35]              â”‚         â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 35%           â”‚         â”‚
â”‚  â”‚                                             â”‚         â”‚
â”‚  â”‚ Deductions:                                â”‚         â”‚
â”‚  â”‚ - High temperature (85Â°C): -40 points      â”‚         â”‚
â”‚  â”‚ - High vibration (8.5 mm/s): -25 points    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### D. Threshold Configuration

```
â”Œâ”€ Threshold Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  â”Œâ”€ motor_temperature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶       â”‚        â”‚
â”‚  â”‚    -50     [70]    [85]        150            â”‚        â”‚
â”‚  â”‚            âš ï¸      ğŸš¨                          â”‚        â”‚
â”‚  â”‚  Warning   Critical                           â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  Hysteresis: [5]Â°C                            â”‚        â”‚
â”‚  â”‚  Debounce: [60] seconds                       â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  Message: "Motor temperature ${value}Â°C       â”‚        â”‚
â”‚  â”‚            exceeds ${level} threshold"        â”‚        â”‚
â”‚  â”‚                                               â”‚        â”‚
â”‚  â”‚  [Edit] [Delete]                              â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                            â”‚
â”‚  [+ Add Threshold]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### E. Event Rules

```
â”Œâ”€ Event Generation Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  â”Œâ”€ High Temperature Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Condition: motor_temperature > 85            â”‚         â”‚
â”‚  â”‚ Event Type: asset.alert.temperature.critical â”‚         â”‚
â”‚  â”‚ Severity: ğŸ”´ Critical                        â”‚         â”‚
â”‚  â”‚ Priority: 1                                  â”‚         â”‚
â”‚  â”‚ Message: "Critical temperature: ${temp}Â°C"   â”‚         â”‚
â”‚  â”‚ Actions:                                     â”‚         â”‚
â”‚  â”‚   â˜‘ Send notification                       â”‚         â”‚
â”‚  â”‚   â˜‘ Create maintenance ticket               â”‚         â”‚
â”‚  â”‚ Cooldown: [15] minutes                       â”‚         â”‚
â”‚  â”‚ [Edit] [Delete] [Test]                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€ Status Change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Condition: status != previous status         â”‚         â”‚
â”‚  â”‚ Event Type: asset.status.changed             â”‚         â”‚
â”‚  â”‚ Severity: â„¹ï¸ Info                            â”‚         â”‚
â”‚  â”‚ Message: "Status changed from ${prev}        â”‚         â”‚
â”‚  â”‚           to ${current}"                     â”‚         â”‚
â”‚  â”‚ [Edit] [Delete]                              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                            â”‚
â”‚  [+ Add Event Rule]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Test Panel

```
â”Œâ”€ Test Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  Test your telemetry configuration with sample data       â”‚
â”‚                                                            â”‚
â”‚  Input Device Telemetry:                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ {                                           â”‚          â”‚
â”‚  â”‚   "device.temp": 85,                        â”‚          â”‚
â”‚  â”‚   "device.voltage": 120,                    â”‚          â”‚
â”‚  â”‚   "device.current": 15,                     â”‚          â”‚
â”‚  â”‚   "device.vibration": 8.5                   â”‚          â”‚
â”‚  â”‚ }                                            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                            â”‚
â”‚  [Run Test]                                               â”‚
â”‚                                                            â”‚
â”‚  Results:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ âœ… Validation Passed                        â”‚          â”‚
â”‚  â”‚                                             â”‚          â”‚
â”‚  â”‚ Transformed Metrics:                        â”‚          â”‚
â”‚  â”‚ â”œâ”€ motor_temperature: 85Â°C                  â”‚          â”‚
â”‚  â”‚ â”œâ”€ voltage: 120V                            â”‚          â”‚
â”‚  â”‚ â”œâ”€ current: 15A                             â”‚          â”‚
â”‚  â”‚ â”œâ”€ vibration_level: 8.5 mm/s                â”‚          â”‚
â”‚  â”‚ â””â”€ power_consumption: 1800W (derived)       â”‚          â”‚
â”‚  â”‚                                             â”‚          â”‚
â”‚  â”‚ Health Score: 35                            â”‚          â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 35%           â”‚          â”‚
â”‚  â”‚                                             â”‚          â”‚
â”‚  â”‚ Threshold Violations:                       â”‚          â”‚
â”‚  â”‚ â”œâ”€ âš ï¸  motor_temperature: Critical (85 > 85) â”‚          â”‚
â”‚  â”‚ â””â”€ âš ï¸  vibration_level: Warning (8.5 > 7.0)  â”‚          â”‚
â”‚  â”‚                                             â”‚          â”‚
â”‚  â”‚ Events Generated:                           â”‚          â”‚
â”‚  â”‚ â”œâ”€ ğŸ”´ asset.alert.temperature.critical      â”‚          â”‚
â”‚  â”‚ â””â”€ ğŸŸ¡ asset.alert.vibration.high            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Backend API Endpoints Needed

### Asset Type Telemetry Configuration

```typescript
// Get telemetry configuration for asset type
GET /api/v1/asset-types/:id/telemetry-config
Response: {
  metricDefinitions: [...],
  transformationEngine: {...},
  healthAlgorithm: {...},
  thresholdRules: {...},
  eventRules: {...}
}

// Update telemetry configuration
PATCH /api/v1/asset-types/:id/telemetry-config
Request: { healthAlgorithm: {...} }

// Test configuration with sample data
POST /api/v1/asset-types/:id/telemetry-config/test
Request: {
  testMetrics: { "device.temp": 85, ... }
}
Response: {
  transformedMetrics: {...},
  healthScore: 35,
  thresholdViolations: [...],
  eventsGenerated: [...]
}

// Get configuration version history
GET /api/v1/asset-types/:id/telemetry-config/versions

// Rollback to previous version
POST /api/v1/asset-types/:id/telemetry-config/rollback
Request: { version: "1.2.0" }
```

---

## 9. Database Schema Alignment

### Current Schema (argusiq-lite)

```typescript
// packages/api/src/db/schema/asset-types.ts
export const assetTypes = pgTable('asset_types', {
  id: uuid('id').primaryKey(),
  organizationId: uuid('organization_id').notNull(),
  name: text('name').notNull(),
  description: text('description'),
  icon: text('icon'),
  category: text('category'),

  attributeSchema: jsonb('attribute_schema'),
  telemetrySchema: jsonb('telemetry_schema'),        // âš ï¸ Vague!
  presentationConfig: jsonb('presentation_config'),

  parentTypeId: uuid('parent_type_id'),
  isSystem: boolean('is_system').default(false),
});
```

### Recommended Changes

```sql
-- Rename and clarify telemetrySchema
ALTER TABLE asset_types
  RENAME COLUMN telemetry_schema TO legacy_telemetry_schema;

-- Add structured telemetry configuration columns
ALTER TABLE asset_types
  ADD COLUMN metric_definitions JSONB,
  ADD COLUMN transformation_engine JSONB,
  ADD COLUMN health_algorithm JSONB,
  ADD COLUMN threshold_rules JSONB,
  ADD COLUMN event_rules JSONB,
  ADD COLUMN aggregation_rules JSONB,
  ADD COLUMN validation_rules JSONB,
  ADD COLUMN telemetry_config_version TEXT DEFAULT '1.0.0',
  ADD COLUMN telemetry_config_updated_at TIMESTAMPTZ DEFAULT NOW(),
  ADD COLUMN telemetry_config_updated_by UUID REFERENCES users(id);

-- Add hierarchical path for easier querying
ALTER TABLE asset_types
  ADD COLUMN path TEXT,  -- "vehicles/trucks/delivery"
  ADD COLUMN level INTEGER;  -- 1, 2, or 3

-- Add indices
CREATE INDEX idx_asset_types_path ON asset_types(path);
CREATE INDEX idx_asset_types_level ON asset_types(level);
CREATE INDEX idx_asset_types_telemetry_version
  ON asset_types(telemetry_config_version, telemetry_config_updated_at);
```

---

## 10. Implementation Priority

### Phase 1: Core Telemetry Processing (Week 1-3)
- âœ… Database schema changes
- âœ… Asset Type Telemetry Configuration table structure
- âœ… Backend API endpoints for CRUD operations
- âœ… Worker integration (Asset Telemetry Worker uses configuration)

### Phase 2: Basic UI (Week 4-5)
- âœ… Add "Telemetry Config" tab to Asset Type details
- âœ… Metric Definitions editor (form-based)
- âœ… Simple transformation rules (JSONPath mappings)
- âœ… Basic threshold configuration

### Phase 3: Advanced UI (Week 6-7)
- âœ… Visual Health Algorithm designer
- âœ… Event Rules editor with condition builder
- âœ… Test panel with live preview
- âœ… Configuration version history

### Phase 4: Production Features (Week 8-9)
- âœ… Configuration validation
- âœ… Hot reload mechanism
- âœ… Rollback support
- âœ… Configuration templates/presets

---

## 11. Summary

### What Aligns âœ…

- **Asset hierarchy** (3 levels) matches architecture design
- **Asset Profiles** for device binding configuration exists in mock
- **Telemetry display** (keys list, dashboard) exists in mock UI
- **Location tracking** (RTLS, floor plans) exists in mock UI
- **Device linking** (asset-device relationships) exists in mock UI

### What's Missing âŒ

- **Telemetry transformation rules** - No UI or backend configuration
- **Health algorithm configuration** - Health score computation is not configurable
- **Threshold management** - Warning/critical levels not configurable per asset type
- **Event generation rules** - No way to define when events are generated
- **Validation rules** - No data quality configuration
- **Test interface** - No way to test telemetry processing

### Recommended Actions ğŸ¯

1. **Extend `asset_types` table** with telemetry configuration columns
2. **Add Telemetry Config tab** to Asset Type details page in mock UI
3. **Build configuration editors** (metrics, transformations, health algorithm, thresholds, events)
4. **Create test panel** for dry-run testing
5. **Update Asset Telemetry Worker** to use configuration-driven processing
6. **Add hot reload mechanism** via Redis cache invalidation

### Integration Points

```
Mock UI Asset Type Page
       â†“
  [Telemetry Config Tab] â† NEW
       â†“
  Configuration saved to asset_types table
       â†“
  Redis cache invalidated
       â†“
  Asset Telemetry Worker picks up new config
       â†“
  Telemetry processed with new rules
       â†“
  Results visible in Asset Dashboard/Telemetry tabs
```

This creates a **complete feedback loop** from configuration UI â†’ processing â†’ results display.
